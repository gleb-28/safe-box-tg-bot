PROMT_INSTRUCTIONS — Safe Box TG Bot

Goal and tone
- A light, lively companion without pressure.
- A bit meme-ish, a bit cozy, sometimes caring.
- Not a strict "reminder", more like a friendly nudge.

Message behavior
- Short, conversational, with 1–4 emoji.
- Always mention the entity (item), rephrasing is allowed.
- Vary sentence structure; avoid moralizing or explanations.
- Sometimes suggest alternatives (rare).
- Use time_of_day rarely and subtly.

Styles (mode)
- rofl: meme-like absurdity.
- cozy: warm and friendly.
- care: soft and caring.

Time logic
- Each user has Timezone, DayStart, DayEnd, NotificationPreset, NotificationsMuted, NextNotification.
- Send only within DayStart → DayEnd.
- Send nothing at night.
- DayStart/DayEnd are minutes in 24-hour format; DayStart != DayEnd is enforced by validation.
- Interval comes from presets (default "Иногда" 60–120 мин; also "Редко" 2–4ч, "Часто" 40–90 мин, "Хаос" 30–180 мин); after send, compute a new NextNotification using the selected preset.

Notifications
- Background worker runs once on startup, then checks users with NextNotification <= now (UTC).
- Skip sends if no items or outside active hours; move NextNotification to the next allowed time.
- Notifications use LLM generation; if it fails, send the item's name plus an emoji.
- If NextNotification is overdue beyond the max interval (or zero), recalculate it from now without sending.
- Avoid repeating the same item within the cooldown window (last 360 minutes); if all items are recent, allow repeats.

Data and models (GORM)
- User: TelegramID, Mode, Timezone, DayStart, DayEnd, NotificationPreset, NotificationIntervalMinMinutes, NotificationIntervalMaxMinutes, NotificationsMuted, NextNotification, ItemBoxClosedMsgID, Items.
- Item: UserID, Name.
- MessageLog: UserID, ItemID, SentAt, Text.
- MessageLog is for history, analysis, anti-repeats, and future personalization.

Item constraints
- Item names are normalized (trim, lowercase, collapse spaces) and limited to 40 characters.
- Max items per user: 200.

Layered architecture
- Models: GORM structs only.
- Repo: thin GORM wrappers with no business logic.
- Session: in-memory cache (User, UserLastMsg, BotLastMsg).
- Service: business logic (load to session, updates, logging).
- Do not auto-create users — only via activation key.

FSM and access
- FSM states: initial, awaiting_key, items_menu_opened, awaiting_item_add, item_edit_select_opened, awaiting_item_edit, item_delete_select_opened.
- /key moves to awaiting_key and asks for the key.
- In awaiting_key, text validates the key:
  - correct key → add user + greetings.
  - wrong key → error and return to initial.
- Auth middleware: if user is not in DB, the bot is silent.
- When closing the item box, send "Шкатулка закрыта" with the main menu keyboard and store the message ID to remove it on next open.
- When opening the item box, prefix the list with a bold status line showing current mode, item count, and the user’s day window (HH:MM–HH:MM).

LLM generation
- Input: current_entity, time_of_day (morning/day/evening or empty), style_mode, random_seed.
- Output: free-form text in Russian, following style rules; prompt builder + LLM service are wired via a message generator.
- Responses are trimmed and code fences (json/text) are stripped before delivery; avoid wrapping answers in fences.
- Must mention the entity and respect the style.
- Prompt template is loaded from PROMPT_PATH (default: data/prompt).
- Users can change the style via `/change_mode`; the current mode is hidden in the inline list, and there is a close button. Frequency is changed via `/change_interval` with the same inline flow and preset buttons (current preset is hidden). Notifications can be muted/unmuted via `/toggle_notifications` (current state hidden). Day window is set via `/change_daytime` with inline hour slots for start then end, echoing the final window.

Tech stack (for integration)
- Go, Telebot v4, Looplab FSM, GORM + SQLite, cleanenv.
- Config via env/.env (TG_BOT_TOKEN, ACTIVATION_KEY, OPENROUTER_API_KEY, OPENROUTER_MODEL_NAME, optional DEEPSEEK_API_KEY/DEEPSEEK_MODEL_NAME, PROMPT_PATH, DB_FILE_NAME).

Working rules for changes
- Load the user into the session first, then update fields.
- Repositories must stay free of business logic.
- Always log sent messages to MessageLog.
- In code, prefer user/userID naming (not chat/chatID).
